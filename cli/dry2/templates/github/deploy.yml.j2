name: Deploy

on:
  push:
    branches:
{% for env in environments %}
      - {{ env.branch }}  # Deploys to {{ env.name }}
{% endfor %}

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set environment
        id: env
        run: |
{% for env in environments %}
          {% if loop.first %}if{% else %}elif{% endif %} [ "${{ github.ref_name }}" == "{{ env.branch }}" ]; then
            echo "environment={{ env.name }}" >> $GITHUB_OUTPUT
            echo "namespace={{ env.name }}" >> $GITHUB_OUTPUT
{% endfor %}
          else
            echo "Unknown branch: ${{ github.ref_name }}"
            exit 1
          fi
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=${{ github.ref_name }}-
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'
      
      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets[format('{0}_KUBECONFIG', steps.env.outputs.environment)] }}" | base64 -d > $HOME/.kube/config
          kubectl config use-context $(kubectl config current-context)
          kubectl get nodes
      
      - name: Create namespace
        run: |
          kubectl create namespace ${{ steps.env.outputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create secrets
        run: |
          kubectl create secret generic django-secrets \
            --namespace=${{ steps.env.outputs.namespace }} \
            --from-literal=SECRET_KEY="${{ secrets[format('{0}_DJANGO_SECRET_KEY', steps.env.outputs.environment)] }}" \
            --from-literal=DATABASE_URL="${{ secrets[format('{0}_DATABASE_URL', steps.env.outputs.environment)] }}" \
            --from-literal=REDIS_URL="${{ secrets[format('{0}_REDIS_URL', steps.env.outputs.environment)] }}" \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy with Helm
        run: |
          IMAGE_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n 1 | cut -d: -f2)
          
          helm upgrade --install {{ project_name }} \
            ./helm/django-app \
            --namespace ${{ steps.env.outputs.namespace }} \
            --set django.image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set django.image.tag=${IMAGE_TAG} \
            --wait --timeout 10m
      
      - name: Run migrations
        run: |
          kubectl run migrations-$(date +%s) \
            --namespace=${{ steps.env.outputs.namespace }} \
            --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }} \
            --restart=Never \
            --env="DATABASE_URL=${{ secrets[format('{0}_DATABASE_URL', steps.env.outputs.environment)] }}" \
            --command -- python manage.py migrate --noinput
      
      - name: Deployment summary
        run: |
          echo "## Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: ${{ steps.env.outputs.namespace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ steps.env.outputs.namespace }} >> $GITHUB_STEP_SUMMARY


